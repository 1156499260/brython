<!doctype html>
<html>
<meta charset="iso-8859-1">
<head>
<style>
body,td,th{
    font-family:sans-serif;
    font-size:12px;
}
td {
    border-style:solid;
    border-width: 0px 0px 1px 0px;
    border-color: #000;
    padding:3px;
}

th {
    border-style:solid;
    border-width: 1px;
    border-color: #000;
    background-color: #61D7A4;
    padding: 4px;
}

span{font-size:15px;
    margin-left:10px;}
a.sort_link{
    margin-left:10px;
    font-size: 15px;
    text-decoration:none;
}

</style>

<script type="text/javascript" src="../src/brython_builtins.js"></script>
<script type="text/javascript" src="../src/version_info.js"></script>
<script type="text/javascript" src="../src/py2js_nevez.js"></script>
<script type="text/javascript" src="../src/py_object.js"></script>
<script type="text/javascript" src="../src/py_type.js"></script>
<script type="text/javascript" src="../src/py_utils.js"></script>
<script type="text/javascript" src="../src/py_sort.js"></script>
<script type="text/javascript" src="../src/py_builtin_functions.js"></script>
<script type="text/javascript" src="../src/py_exceptions.js"></script>
<script type="text/javascript" src="../src/py_range_slice.js"></script>
<script type="text/javascript" src="../src/py_bytes.js"></script>
<script type="text/javascript" src="../src/py_set.js"></script>
<script type="text/javascript" src="../src/js_objects.js"></script>
<script type="text/javascript" src="../src/stdlib_paths.js"></script>
<script type="text/javascript" src="../src/py_import_nevez.js"></script>
<script type="text/javascript" src="../src/unicode.min.js"></script>
<script type="text/javascript" src="../src/py_string.js"></script>
<script type="text/javascript" src="../src/py_int.js"></script>
<script type="text/javascript" src="../src/py_long_int.js"></script>
<script type="text/javascript" src="../src/py_float.js"></script>
<script type="text/javascript" src="../src/py_complex.js"></script>
<script type="text/javascript" src="../src/py_dict.js"></script>
<script type="text/javascript" src="../src/py_list.js"></script>
<script type="text/javascript" src="../src/py_generator.js"></script>
<script type="text/javascript" src="../src/py_dom.js"></script>

<script type="text/javascript" src="../src/builtin_modules.js"></script>
<script type="text/javascript" src="../src/py_import_hooks.js"></script>
<script type="text/javascript" src="../src/async.js"></script>

<style>
#output{
    font-family: Consolas, "Courier New";
    padding: 0.5em;
    background-color: #000;
    color: #fff;
    width: 100%;
    overflow: auto;
    white-space: pre-wrap;
}
</style>
</head>
<body onLoad="brython(1)">
<div id="banner_row"></div>

<script type="text/pythonXXX">
import datetime
print(datetime)
print(datetime.datetime.now())
</script>

<script type="text/pythonXXX">
import header
header.show()

import import_test
print(import_test.valude)
</script>

<script>
var imports = ["browser", "math", "re", "header"]

function show(){
    if(this.readyState==4){
        if(this.status==200){
            __BRYTHON__.module_source[this.url] = this.responseText.length
            if(this.path != "libs"){
                var root = __BRYTHON__.py2js(this.responseText, this.url, this.url, "__builtins__")
                __BRYTHON__.module_source[this.url] = root.to_js()
                for(var key in root.imports){
                    if(!__BRYTHON__.module_source.hasOwnProperty(key)){
                        tasks.splice(0, 0, [inImported, key])
                    }
                }
            }
        }else if(this.status==404){
            if(this.path == "Lib"){
                tasks.splice(0, 0, [ajax_libs, this.url, show])
            }else if(this.path == "libs"){
                tasks.splice(0, 0, [ajax_current_dir, this.url, show])
            }else if(this.path == "current-dir"){
                tasks.splice(0, 0, [ajax_site_packages, this.url, show])
            }
        }
        loop()
    }
}

function inImported(url){
    if(__BRYTHON__.imported.hasOwnProperty(url)){
        __BRYTHON__.module_source[url] = "in imported"
    }else if(__BRYTHON__.stdlib.hasOwnProperty(url)){
        tasks.splice(0, 0, [idb_search, url])
    }else{
        tasks.splice(0, 0, [ajax_current_dir, url, show])
    }
    loop()
}

var idb_cx

function idb_show(evt, url){
    var res = evt.target.result
    if(res!==undefined){
        __BRYTHON__.module_source[url] = res.content
        if(res.ext==".pyjs"){
            if(res.imports.length>0){
                var subimports = res.imports.split(",")
                for(var i=0;i<subimports.length;i++){
                    var subimport = subimports[i]
                    if(subimport==""){
                        console.log('bizarre', url)
                    }
                    if(subimport.startsWith(".")){
                        var url_elts = url.split("."),
                            nb_dots = 0
                        while(subimport.startsWith(".")){
                            nb_dots++
                            subimport = subimport.substr(1)
                        }
                        var elts = url_elts.slice(0, nb_dots)
                        if(subimport){
                            elts = elts.concat([subimport])
                        }
                        subimport = elts.join(".")
                    }
                    if(!__BRYTHON__.imported.hasOwnProperty(subimport) &&
                            !__BRYTHON__.module_source.hasOwnProperty(subimport)){
                        // for modules imported by modules of the stdlib, only
                        // search in indexedDB, don't try ajax calls
                        tasks.splice(0, 0, [idb_search, subimport])
                    }
                }
            }
        }else if(res.ext==".js"){
            var src = res.content
            src += "\nvar $locals_" +
                url.replace(/\./g, "_") + " = $module"
            __BRYTHON__.module_source[url] = src
        }
    }
    loop()
}

function idb_get(url, callback){
    //console.log('idb get', url, f)
    var db = idb_cx.result,
        tx = db.transaction("modules", "readonly")
        store = tx.objectStore("modules")
        req = store.get(url)
    req.onsuccess = callback
}

function idb_search(url, callback){
    idb_cx = indexedDB.open("brython_stdlib")
    idb_cx.onsuccess = function(){
        tasks.splice(0, 0, [idb_get, url, function(evt){idb_show(evt, url)}])
        loop()
    }
    idb_cx.onupgradeneeded = function(){
        console.log('upgradeneeded')
        loop()
    }
}

function ajax_Lib(url, callback){
    var req = new XMLHttpRequest()
    req.open("GET", "/src/Lib/" + url + ".py", true)
    req.onreadystatechange = callback
    req.url = url
    req.path = "Lib"
    req.send()
}

function ajax_libs(url, callback){
    var req = new XMLHttpRequest()
    req.open("GET", "/src/libs/" + url + ".js", true)
    req.onreadystatechange = callback
    req.url = url
    req.path = "libs"
    req.send()
}

function ajax_current_dir(url, callback){
    var req = new XMLHttpRequest()
    req.open("GET", url + ".py", true)
    req.onreadystatechange = callback
    req.url = url
    req.path = "current-dir"
    req.send()
}

function ajax_site_packages(url, callback){
    var req = new XMLHttpRequest()
    req.open("GET", "/src/Lib/site-packages/" + url + ".py", true)
    req.onreadystatechange = callback
    req.url = url
    req.path = "site-packages"
    req.send()
}

var tasks = [],
    scripts = document.querySelectorAll('[type="text/pythonXXX"]')

console.log(scripts)
for(var i=0; i<scripts.length; i++){
    var src = scripts[i].textContent,
        root = __BRYTHON__.py2js(src, "__main__" + i, "__main__" + i, "__builtins__"),
        js = root.to_js(),
        imports = Object.keys(root.imports)

    for(var j=0; j<imports.length;j++){
       tasks.push([inImported, imports[j]])
    }
    tasks.push(["execute", js])
}

console.log('initial', tasks.splice())

function loop(){
    if(tasks.length==0){
        console.log('fini')
        return
    }
    var task = tasks.shift()
    var func = task[0],
        arg = task[1],
        callback = task[2]
    if(func == "execute"){
        eval(arg)
        loop()
    }else{
        func(arg, callback)
    }
}

loop()

</script>


</body>
</html>
